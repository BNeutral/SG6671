<!doctype html>
<html>

<head>
<title>SG6671 - TP1</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<script type="text/javascript" src="lib/gl-matrix.js"></script>
<script type="text/javascript" src="lib/webgl-utils.js"></script>
<script type="text/javascript" src="src/funcionesAuxiliares.js"></script>
<script type="text/javascript" src="src/herencia.js"></script>
<script type="text/javascript" src="src/glSetup.js"></script>
<script type="text/javascript" src="src/malla.js"></script>
<script type="text/javascript" src="src/normalData.js"></script>
<script type="text/javascript" src="src/textura.js"></script>
<script type="text/javascript" src="src/objeto.js"></script>
<script type="text/javascript" src="src/escena.js"></script>
<script type="text/javascript" src="src/camara.js"></script>
<script type="text/javascript" src="src/camaraPrimeraPersona.js"></script>
<script type="text/javascript" src="src/camaraOrbital.js"></script>
<script type="text/javascript" src="src/camaraCarrito.js"></script>


<script type="text/javascript" src="src/curvas/curva.js"></script>
<script type="text/javascript" src="src/curvas/bezier.js"></script>
<script type="text/javascript" src="src/curvas/bezierConcat.js"></script>
<script type="text/javascript" src="src/curvas/bspline3.js"></script>
<script type="text/javascript" src="src/curvas/bspline3Concat.js"></script>

<script type="text/javascript" src="src/objetos/grilla.js"></script>
<script type="text/javascript" src="src/objetos/piso.js"></script>
<script type="text/javascript" src="src/objetos/cubo.js"></script>
<script type="text/javascript" src="src/objetos/disco.js"></script>
<script type="text/javascript" src="src/objetos/cilindro.js"></script>
<script type="text/javascript" src="src/objetos/superficieRevolucion.js"></script>
<script type="text/javascript" src="src/objetos/baseSillitas.js"></script>
<script type="text/javascript" src="src/objetos/techoSillitas.js"></script>
<script type="text/javascript" src="src/objetos/sillitas.js"></script>
<script type="text/javascript" src="src/objetos/silla.js"></script>
<script type="text/javascript" src="src/objetos/ejes.js"></script>
<script type="text/javascript" src="src/objetos/vuelta.js"></script>
<script type="text/javascript" src="src/objetos/mRusa.js"></script>
<script type="text/javascript" src="src/objetos/lago.js"></script>
<script type="text/javascript" src="src/objetos/sigueCurva.js"></script>
<script type="text/javascript" src="src/objetos/carro.js"></script>
<script type="text/javascript" src="src/objetos/objUtil.js"></script>

<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec2 vTextureCoord;
    varying vec3 vLightWeighting;

    uniform sampler2D uSampler;

    void main(void) 
    {
        vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
        gl_FragColor = vec4(textureColor.rgb * vLightWeighting, textureColor.a);
    }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec3 aVertexNormal;
    attribute vec2 aTextureCoord;

    uniform mat4 uViewMatrix;
    uniform mat4 uModelMatrix;
    uniform mat4 uPMatrix;
    uniform mat3 uNMatrix;


    ///////////////////////////////////////////////////////////////////////////////////////////
    //
    // Variables uniformes involucradas en la iluminación de la escena
    // 
    // uAmbientColor - representa una intensidad de luz constante que
    // ilumina a todos los objetos sin provenir de una dirección o fuente de luz determinada
    // Es un nivel de intensidad de luz omni-presente
    //
    // uLightPosition - Representa la posición en coordenadas de la escena o mundo donde
    // donde se ubica una luz puntual. Este tipo de luz irradia en todas direcciones.
    // Las superficies (triángulos) cuya normal apunte a esta posición será las que recibirán
    // la máxima intensidad y por lo tanto serán las más iluminadas.
    // A medida que la normal se aparte de esta dirección la intensidad disminuye y en caso que se
    // ubique de manera ortogonal la intensidad será nula
    //
    // uDirectionalColor - Representa el color de la luz puntual
    //
    // uUseLighting - Variable booleana que activa / descativa el cálculo de la iluminación
    uniform vec3 uAmbientColor;
    uniform vec3 uLightPosition;
    uniform vec3 uDirectionalColor;
    uniform bool uUseLighting;
    //
    ////////////////////////////////////////////////////////////////////////////////////////////
    
    varying vec2 vTextureCoord;
    varying vec3 vLightWeighting;

    void main(void) 
    {
	
            // Transformamos al vértice al espacio de la cámara
            vec4 pos_camera_view = uViewMatrix * uModelMatrix * vec4(aVertexPosition, 1.0);
            // Transformamos al vértice al espacio de la proyección
            gl_Position = uPMatrix * pos_camera_view;
            // Coordenada de textura sin modifiaciones
            vTextureCoord = aTextureCoord;

            ////////////////////////////////////////////
            // Calculos de la iluminación
            vec3 light_dir_normalized =  normalize(uLightPosition - vec3( pos_camera_view ) );
            if (!uUseLighting) 
            {
                vLightWeighting = vec3(1.0, 1.0, 1.0);
            }
            else 
            {
                vec3 transformedNormal = normalize(uNMatrix * aVertexNormal);
                float directionalLightWeighting = max(dot(transformedNormal, light_dir_normalized), 0.0);
                vLightWeighting = uAmbientColor + uDirectionalColor * directionalLightWeighting;
            }
		////////////////////////////////////////////
    }
</script>

<script type="text/javascript">

    var gl;
    var shaderProgram;
    var escena;    
    var mRusa;
    var renderizarLineas = 0;  // Si se debe renderear como lineas en vez de superficies
    
    
    var mouseDown = false;
    var lastMouseX = null;
    var lastMouseY = null;
    
    
    var pitch = 0;
    var pitchRate = 0;

    var yaw = 0;
    var yawRate = 0;
    var joggingAngle = 0;
    var speed = 0;    
    
    var yPosInicial= 1;
    var xPos = 0;
    var yPos = yPosInicial;
    var zPos = 0;

    var deltaX=0;
    var deltaY=0.1;
    
    var ultimoTiempo = 0;
  
  
    function handleMouseDown(event) {
      mouseDown = true;
      lastMouseX = event.clientX;
      lastMouseY = event.clientY;
    }

    function handleMouseUp(event) {
      mouseDown = false;
    }

    function handleMouseMove(event) {
      if (!mouseDown) {
	return;
      }
      var newX = event.clientX;
      var newY = event.clientY;

      deltaX = newX - lastMouseX;
      deltaY = newY - lastMouseY;

    }
  
    var currentlyPressedKeys = {};
    
    function handleKeyDown(event) {
        currentlyPressedKeys[event.keyCode] = true;
    }


    function handleKeyUp(event) {
        currentlyPressedKeys[event.keyCode] = false;
    }

    
    var lastTime = 0;
    
    function animate() {
        var timeNow = new Date().getTime();
        if (lastTime != 0) {
            var elapsed = timeNow - lastTime;

            if (speed != 0) {
                xPos -= Math.sin(degToRad(yaw)) * speed * elapsed;
                zPos -= Math.cos(degToRad(yaw)) * speed * elapsed;

                joggingAngle += elapsed * 0.6;
                yPos = Math.sin(degToRad(joggingAngle)) / 20 + yPosInicial;
            }

            yaw += yawRate * elapsed;
            pitch += pitchRate * elapsed;
            pitch -= deltaY/30;
            yaw -= deltaX/30 ;

        }
        lastTime = timeNow;
    }
    
    //Cuando se cambia de camara, debo volver al angulo inicial
    function reiniciarAngulo() {
        pitch = 0;
        yaw = 0;
    }


    function handleKeys() {

        if (currentlyPressedKeys[33]) {
            // Page Up
            pitchRate = 0.1;
        } else if (currentlyPressedKeys[34]) {
            // Page Down
            pitchRate = -0.1;
        } else {
            pitchRate = 0;
        }
        
        if (currentlyPressedKeys[37] || currentlyPressedKeys[65]) {
	  // Izquierda o A
	  yawRate = 0.1;
	} else if (currentlyPressedKeys[39] || currentlyPressedKeys[68]) {
	  // Derecha o D
	  yawRate = -0.1;
	} else {
	  yawRate = 0;
	}
	
        //Las siguientes solamente deberian funcionar si estoy en modo primera persona
        if(escena.numeroCamara()==0) {
	    if (currentlyPressedKeys[38] || currentlyPressedKeys[87]) {
		// Arriba o W
		speed = 0.003;
	    } else if (currentlyPressedKeys[40] || currentlyPressedKeys[83]) {
		// Abajo
		speed = -0.003;
	    } else {
	      speed = 0;
	    }
        }
        
        if (currentlyPressedKeys[67] ) {
            // Letra c, cambiar camara
            escena.cambiarCamara();
            reiniciarAngulo();
            //Funcion sleep usada para que no cambie
	    // tan rapido la camara al presionar "e"
            sleep(200);
        } 

        // Aprete ESC para renderear como lineas
        if (currentlyPressedKeys[27]) renderizarLineas = 1;
        else renderizarLineas = 0;
    }
    
    function update() 
    {
        var tiempoActual = requestAnimFrame(update) / 25; // Interpretese como tiempo en milisegundos, aunque no sea
        var deltaT = tiempoActual - ultimoTiempo;
        ultimoTiempo = tiempoActual;        
       
        handleKeys();
        animate();
        
        if (!mouseDown) {
	  deltaX=0;
	  deltaY=0;
	}
	
	//mat=mRusa.obtenerPosicionCarrito();

	//escena.camaras[2].multMatriz(mat);
	
        escena.setVariables(pitch,yaw,xPos,yPos,zPos,deltaX,deltaY);
        escena.update(deltaT);
        escena.dibujar();
    }


    function agregarObjetos() 
    {
        escena.agregarObjeto(new Ejes());
        escena.agregarObjeto(new Objeto(null, null));
        escena.agregarObjeto(new Grilla(10,10,"texturas/debug.jpg",1.0,1.0));
        var cubo = new Cubo("texturas/debug.jpg");
        mat4.translate(cubo.matrices, cubo.matrices, [2,1,0]);
        escena.agregarObjeto(cubo);
        var cilindro = new Cilindro(8, 2, "texturas/debug.jpg");
        mat4.translate(cilindro.matrices, cilindro.matrices, [-2,1,0]);
        escena.agregarObjeto(cilindro);
        var disco = new Disco(32, "texturas/debug.jpg");
        mat4.translate(disco.matrices, disco.matrices, [0,2,0]);
        escena.agregarObjeto(disco);    
        /*escena.agregarObjeto(new Carro()); */

       /* mRusa = new MRusa();
        mat4.translate(mRusa.matrices, mRusa.matrices, [-10,0,10]);
        escena.agregarObjeto(mRusa);
        var lago = new Lago();
        mat4.translate(lago.matrices, lago.matrices, [-3,0,11]);
        escena.agregarObjeto(lago);

        //el primer parametro es el numero de sillas
        // Si se ponen demasiadas, se va a amontonar...
        //el segundo es la velocidad
	var sillitas= new Sillitas(8,2);
	mat4.translate(sillitas.matrices, sillitas.matrices, [12,0,0]);
        escena.agregarObjeto(sillitas); 

        var vuelta = new Vuelta(12, 8.0);
        mat4.translate(vuelta.matrices, vuelta.matrices, [-5,0,-10]);
        mat4.rotate(vuelta.matrices, vuelta.matrices, Math.PI/4, [0,-1,0]);
        escena.agregarObjeto(vuelta);*/

        escena.agregarObjeto(new Piso());
    }
    
    function webGLStart()
    {
        var canvas = document.getElementById("TP1-SistemasGraficos");
        initGL(canvas);
        initShaders();
        
        var camaraPrimera = new CamaraPrimeraPersona(canvas.width, canvas.height);
        var camaraOrbital = new CamaraOrbital(canvas.width, canvas.height);
        var camaraCarrito = new CamaraCarrito(canvas.width, canvas.height);

        escena = new Escena(camaraPrimera);
        escena.agregarCamara(camaraOrbital);
        escena.agregarCamara(camaraCarrito);
        agregarObjetos();
        
        document.onkeydown = handleKeyDown;
        document.onkeyup = handleKeyUp;
        
        canvas.onmousedown = handleMouseDown;
	document.onmouseup = handleMouseUp;
	document.onmousemove = handleMouseMove;
        
        gl.clearColor(0.8, 0.8, 1.0, 1.0);
        gl.enable(gl.DEPTH_TEST);

	update();
    }

</script>

</head>

<body onload="webGLStart();">
    <center>
        <h1>Sistemas Gráficos - TP1</h1>
        <canvas id="TP1-SistemasGraficos" style="border: none;" width="1280" height="720">
        Your browser does not support the HTML5 canvas element.
        </canvas>
        <p>C                - Camaras</p>
        <p>WASD             - Movimiento primera persona</p>
        <p>Click + Mouse    - Rotar camaras</p>
    </center>
</body>
</html>